<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting" xmlns:oauth="http://www.mulesoft.org/schema/mule/oauth" xmlns:email="http://www.mulesoft.org/schema/mule/email" xmlns:mongo="http://www.mulesoft.org/schema/mule/mongo" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/mongo http://www.mulesoft.org/schema/mule/mongo/current/mule-mongo.xsd
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd
http://www.mulesoft.org/schema/mule/oauth http://www.mulesoft.org/schema/mule/oauth/current/mule-oauth.xsd
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd">
	<sub-flow name="post-usersSub_Flow" doc:id="cfd35cee-029e-46d7-8cc5-d0bc85efd33e" >
		<flow-ref doc:name="check-users-collection" doc:id="64174c32-cf4b-4326-9ded-787d96b4f98e" name="check-users-collection-Sub_Flow" target="vars.collection" />
		<ee:transform doc:name="email_search_query variable -&gt; Prepare the search query" doc:id="53817ccd-c551-4c5c-8a1e-6991ba84e148">
			<ee:message></ee:message>
			<ee:variables>
				<ee:set-variable variableName="email_search_query">
					<![CDATA[%dw 2.0
output application/json
---
{
	'email': lower(payload.email as String)
}]]>
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<mongo:find-documents doc:name="check if the email is used" doc:id="c6bcaf9e-f527-4488-8452-99324594d5c1" config-ref="MongoDB_Config_Secured" collectionName="${mongoDb.collections.users}" fields="email" target="email_search_resonse" targetValue="#[output application/json&#10;---&#10;payload]">
			<mongo:query>
				<![CDATA[#[vars.email_search_query]]]>
			</mongo:query>
		</mongo:find-documents>
		<choice doc:name="choice based on the email usage in the database" doc:id="c52d9590-c16d-44e4-aef6-90c2f7b7ba6d">
			<when expression="#[sizeOf(vars.email_search_resonse) == 0]">
				<ee:transform doc:name="prepare the body of the user with the default fields" doc:id="84024c52-2eec-4638-9b56-5a5158058eee">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
import dw::Crypto
output application/json skipNullOn="everywhere"
var hashedPassword = Crypto::SHA1(payload.password as Binary)
---
payload  -- {password: payload.password} ++ {password: hashedPassword}
++ {
  "status": "pending",
  "role": "user",
  "created_at": now(),
  "last-activity": null,
  "last-update": null,
  "activated_at": now()
}]]>
						</ee:set-payload>
					</ee:message>
				</ee:transform>
				<mongo:insert-document doc:name="Insert the user and prepare the returned value" doc:id="e698c56d-b2f7-4d9d-ace9-787819244612" config-ref="MongoDB_Config_Secured" collectionName="${mongoDb.collections.users}" targetValue='#[output application/json skipNullOn="everywhere"&#10;---&#10;payload -- {password: payload.password}]' />
				<flow-ref doc:name="Flow Reference" doc:id="742a50e0-2a9f-41c2-96ed-345ad78d34c8" name="generate-token-send-email-Sub-Flow" target="email_sent"/>
				<ee:transform doc:name="remove password from returned payload" doc:id="d18d22bc-5413-4879-b8a9-52c7f6769ce2">
					<ee:message>
						<ee:set-payload><![CDATA[output application/json
---
payload -- {password: payload.password}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<raise-error doc:name="Raise error" doc:id="aadefba5-6885-471d-8d37-cab532449dd0" type="PERSONAL:UNPROCESSABLE_ENTITY" description="Email is already used." />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="generate-token-send-email-Sub-Flow" doc:id="9d7ff7fe-f177-45c8-a794-0a48376476ef" >
		<flow-ref doc:name="Flow Reference" doc:id="952d0bda-9e93-49b4-a6aa-9f02e642db26" name="generate-random-text-Sub-Flow" target="random_text" />
		<ee:transform doc:name="prepare the token payload" doc:id="1daddfcf-7856-4ceb-94f8-92afe93252af">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	id: payload."_id"."\$oid" as String,
	email: payload.email as String,
	random_text: vars.random_text as String,
	action: "activate"
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
		<flow-ref doc:name="Flow Reference" doc:id="e4813d03-14b3-4236-a088-62681d90a5b8" name="generate-token-Sub_Flow" target="recieved_token"/>
		<email:send doc:name="Send" doc:id="fbc3ad0e-a22b-4933-b345-d8c4010d774a" config-ref="Hotmail_Email_SMTP" fromAddress="ReasonOfHope@hotmail.com" subject="Please verify your email">
			<reconnect />
			<email:to-addresses>
				<email:to-address value="#[payload.email]" />
			</email:to-addresses>
			<email:body>
				<email:content><![CDATA[#[output text/plain
---
"Subject: Welcome to Our Service, {name}!

Dear {name},

Thank you for signing up. Please activate your account using the code below:

Activation Code: {activation_code}" ++ "\nhttp://localhost:8091/users/status/" ++  (vars.recieved_token as String) ++
"Copy the above code and paste it in the activation field to activate your account.

Thank you,
Your Team"]]]></email:content>
			</email:body>
		</email:send>
	</sub-flow>
</mule>